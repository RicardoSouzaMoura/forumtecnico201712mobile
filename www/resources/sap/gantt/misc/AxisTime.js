/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Core","sap/gantt/misc/Utility","sap/ui/thirdparty/d3"],function(B,C){"use strict";var A=function(t,v,z,a,b,l,Z){this.scale=d3.time.scale().domain(t).range(v).clamp(false);this.timeRange=t;this.viewRange=v;this.zoomRate=sap.gantt.misc.Utility.assign(z,1);this.zoomOrigin=sap.gantt.misc.Utility.assign(a,0);this.viewOffset=sap.gantt.misc.Utility.assign(b,0);this.locale=l;if(l&&l.getUtcdiff()){var f=d3.time.format("%Y%m%d%H%M%S");this.timeZoneOffset=Math.round((f.parse("20000101"+l.getUtcdiff()).getTime()-f.parse("20000101000000").getTime())/1000);if(l.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset;}}this._oZoomStrategy=Z?Z:sap.gantt.config.DEFAULT_TIME_ZOOM_STRATEGY;};A.prototype.CONSTANT={C_SEPARATOR:"_@@_",C_MESSAGE:{ARGUMENT_ERROR:"AxisOrdinal: Argument Error!"}};A.prototype.timeToView=function(t){if(C.getConfiguration().getRTL()!==true){return Math.round((this.scale(t)-this.zoomOrigin)*this.zoomRate-this.viewOffset);}else{return Math.round(this.viewRange[1]*this.zoomRate-(((this.scale(t)+this.zoomOrigin)*this.zoomRate)+this.viewOffset));}};A.prototype.viewToTime=function(v){if(C.getConfiguration().getRTL()!==true){return this.scale.invert((v+this.viewOffset)/this.zoomRate+this.zoomOrigin);}else{return this.scale.invert(this.viewRange[1]-(v+this.viewOffset)/this.zoomRate-this.zoomOrigin);}};A.prototype.setTimeRange=function(t){this.timeRange=t;this.scale.domain(t);return this;};A.prototype.getTimeRange=function(){return this.scale.domain();};A.prototype.setViewRange=function(v){this.viewRange=v;this.scale.range(v);return this;};A.prototype.getViewRange=function(){var r=this.scale.range();return[Math.round((r[0]-this.zoomOrigin)*this.zoomRate-this.viewOffset),Math.round((r[1]-this.zoomOrigin)*this.zoomRate-this.viewOffset)];};A.prototype.getZoomStrategy=function(){return this._oZoomStrategy;};A.prototype.setZoomRate=function(z){this.zoomRate=sap.gantt.misc.Utility.assign(z,1);return this;};A.prototype.getZoomRate=function(){return this.zoomRate;};A.prototype.setZoomOrigin=function(z){this.zoomOrigin=sap.gantt.misc.Utility.assign(z,0);return this;};A.prototype.getZoomOrigin=function(){return this.zoomOrigin;};A.prototype.setViewOffset=function(v){this.viewOffset=sap.gantt.misc.Utility.assign(v,0);return this;};A.prototype.getViewOffset=function(){return this.viewOffset;};A.prototype.setLocale=function(l){this.locale=l;if(l&&l.getUtcdiff()){var f=d3.time.format("%Y%m%d%H%M%S");this.timeZoneOffset=Math.round((f.parse("20000101"+l.getUtcdiff()).getTime()-f.parse("20000101000000").getTime())/1000);if(l.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset;}}return this;};A.prototype.getLocale=function(){return this.locale;};A.prototype.clone=function(){return new A([new Date(this.timeRange[0].valueOf()),new Date(this.timeRange[1].valueOf())],this.viewRange.slice(0),this.zoomRate,this.zoomOrigin,this.viewOffset,this.locale);};A.prototype.getCurrentTickTimeIntervalLevel=function(){var s=d3.time.format("%Y%m%d%H%M%S").parse("20000101000000");var a=this.scale(s);var c=0;for(var i in this._oZoomStrategy){var b=this._oZoomStrategy[i].innerInterval;var e=this.scale(jQuery.sap.getObject(b.unit).offset(s,b.span));var r=Math.ceil((e-a)*this.zoomRate);if(r>=b.range){return c;}c++;}return c-1;};A.prototype.getCurrentTickTimeIntervalKey=function(){var s=d3.time.format("%Y%m%d%H%M%S").parse("20000101000000");var a=this.scale(s);var c,i;for(i in this._oZoomStrategy){var b=this._oZoomStrategy[i].innerInterval;var e=this.scale(jQuery.sap.getObject(b.unit).offset(s,b.span));var r=Math.ceil((e-a)*this.zoomRate);if(r>=b.range){c=i;break;}}return c?c:i;};A.prototype.getNowLabel=function(){var d=new Date();var u=new Date(d.getTime()+(d.getTimezoneOffset()*60000));var v=this.timeToView(u);var l=d3.time.second.offset(u,this.timeZoneOffset);var a=this.getTimeLabel(C.getConfiguration().getLanguage().toLowerCase(),this._oZoomStrategy[this.getCurrentTickTimeIntervalKey()].smallInterval.format,l);return[{"date":l,"value":Math.round(v),"label":a}];};A.prototype.getTickTimeIntervalLabel=function(l,t,v){var i;var a=l;if(typeof l==="number"){var c=0;for(i in this._oZoomStrategy){if(c===l){a=i;break;}c++;}}var p,b;var e=null;if(this.locale&&this.locale.getDstHorizons().length>0){e=this.locale.getDstHorizons();}var f=d3.time.format("%Y%m%d%H%M%S");var g=[];if(e){for(i=0;i<e.length;i++){g[i]={};p=e[i].getStartTime();b=e[i].getEndTime();g[i].startDate=f.parse(p);g[i].endDate=f.parse(b);}}var h=this.timeZoneOffset?[d3.time.second.offset(this.timeRange[0],this.timeZoneOffset),d3.time.second.offset(this.timeRange[1],this.timeZoneOffset)]:this.timeRange;var j=new sap.gantt.misc.AxisTime(h,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null);var k=null;var m=null;var n=null;var o=null;var q=null;var r=null;var u=null;var w=[];var x=[];var y=null;if(t){r=this.timeZoneOffset?d3.time.second.offset(t[0],this.timeZoneOffset):t[0];u=this.timeZoneOffset?d3.time.second.offset(t[1],this.timeZoneOffset):t[1];k=this.timeZoneOffset?[d3.time.second.offset(t[0],this.timeZoneOffset),d3.time.second.offset(t[1],this.timeZoneOffset)]:t;m=[this.timeToView(t[0]),this.timeToView(t[1])];if(g&&g.length){this._calculateTimeRange(g,r,u,w);}y=this._calculateScale(w,x,k,m,false);}else if(v){r=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(v[0]),this.timeZoneOffset):this.viewToTime(v[0]);u=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(v[1]),this.timeZoneOffset):this.viewToTime(v[1]);k=[r,u];m=v;if(g.length){this._calculateTimeRange(g,r,u,w);}y=this._calculateScale(w,x,k,m,false);}else{r=h[0];u=h[1];k=h;m=this.viewRange;if(g.length){this._calculateTimeRange(g,r,u,w);}y=this._calculateScale(w,x,k,m,h);}x=y.viewRangeSet;n=y.visibleScale;o=y.dstScale;q=y.normalScale;var z=[];var D,E,F,G;var H=this._oZoomStrategy[a].largeInterval;var I=this._oZoomStrategy[a].smallInterval;var J,K;if(H){var L=[];var M=[];var N=[];if(!(n instanceof Array)){L[0]=n.ticks(jQuery.sap.getObject(H.unit).range,H.span);}else{for(J=0;J<o.length;J++){M[J]=o[J].ticks(jQuery.sap.getObject(H.unit).range,H.span);N[J]=q[J].ticks(jQuery.sap.getObject(H.unit).range,H.span);}for(J=0;J<n.length;J++){L[J]=n[J].ticks(jQuery.sap.getObject(H.unit).range,H.span);}}var O=[];if(L[0]!==null){for(J=0;J<L.length;J++){for(K=0;K<L[J].length;K++){D=L[J][K];F=j.timeToView(D);G=this.getTimeLabel(C.getConfiguration().getLanguage().toLowerCase(),H.format,D);O.push({"date":D,"value":Math.round(F),"label":G});}}}if(M[0]!==null){for(J=0;J<M.length;J++){for(K=0;K<M[J].length;K++){D=M[J][K];E=N[J][K];F=j.timeToView(d3.time.second.offset(D.getTime(),-60*60));G=this.getTimeLabel(C.getConfiguration().getLanguage().toLowerCase(),H.format,D);O.push({"date":D,"value":Math.round(F),"label":G});}}}z.push(O);}else{z.push([]);}if(I){var P=[];var Q=[];var R=[];if(!(n instanceof Array)){R[0]=n.ticks(jQuery.sap.getObject(I.unit).range,I.span);}else{for(J=0;J<o.length;J++){P[J]=o[J].ticks(jQuery.sap.getObject(I.unit).range,I.span);Q[J]=q[J].ticks(jQuery.sap.getObject(I.unit).range,I.span);}for(J=0;J<n.length;J++){R[J]=n[J].ticks(jQuery.sap.getObject(I.unit).range,I.span);}}var S=[];if(R[0]){for(J=0;J<R.length;J++){for(K=0;K<R[J].length;K++){D=R[J][K];var T;var U=false;if(g.length){for(var d=0;d<g.length;d++){if(D.getTime()===g[d].startDate.getTime()){T=d3.time.second.offset(D.getTime(),60*60);if((K===R[J].length-1)&&(a==="1hour"||a==="30min"||a==="15min"||a==="10min"||a==="5min")){U=true;}}if((K===R[J].length-1)&&(D.getTime()===d3.time.second.offset(g[d].endDate.getTime(),60*60).getTime())){T=d3.time.second.offset(D.getTime(),-60*60);}}}F=j.timeToView(D);if(U){break;}else if(T){G=this.getTimeLabel(C.getConfiguration().getLanguage().toLowerCase(),I.format,T);T=null;}else{G=this.getTimeLabel(C.getConfiguration().getLanguage().toLowerCase(),I.format,D);}S.push({"date":D,"value":Math.round(F),"label":G});}}}if(P[0]){for(J=0;J<P.length;J++){for(K=0;K<P[J].length;K++){D=P[J][K];E=Q[J][K];var V;var W=false;if((K===P[J].length-1)&&(a==="1hour"||a==="30min"||a==="15min"||a==="10min"||a==="5min")){if(w.length>0){for(var X=0;X<w.length;X++){if((!w[X].haveDST)&&(E.getTime()===w[X].range[0].getTime())){W=true;}}}}if(g.length){for(var s=0;s<g.length;s++){if(D.getTime()===g[s].startDate.getTime()){V=d3.time.second.offset(D.getTime(),60*60);}if((K===P[J].length-1)&&(D.getTime()===d3.time.second.offset(g[s].endDate.getTime(),60*60).getTime())){V=d3.time.second.offset(D.getTime(),-60*60);}}}if(a!=="1hour"&&a!=="30min"&&a!=="15min"&&a!=="10min"&&a!=="5min"){F=j.timeToView(d3.time.second.offset(D.getTime(),-60*60));}else{F=j.timeToView(E);}if(W){break;}else if(V){G=this.getTimeLabel(C.getConfiguration().getLanguage().toLowerCase(),I.format,V);V=null;}else{G=this.getTimeLabel(C.getConfiguration().getLanguage().toLowerCase(),I.format,D);}S.push({"date":D,"value":Math.round(F),"label":G});}}}z.push(S);}else{z.push([]);}return z;};A.prototype._calculateScale=function(a,v,b,c,l){var d=null;var e=[];var n=[];if(a.length){d=[];var f=0;var g=0;for(var t=0;t<a.length;t++){v[t]=[this.timeToView(a[t].range[0]),this.timeToView(a[t].range[1])];if(a[t].haveDST){e[f]=new sap.gantt.misc.AxisTime(a[t].dstRange,v[t],this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale;n[f]=new sap.gantt.misc.AxisTime(a[t].range,v[t],this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale;f++;}else{d[g]=new sap.gantt.misc.AxisTime(a[t].range,v[t],this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale;g++;}}}else if(l){d=new sap.gantt.misc.AxisTime(l,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale;}else{d=new sap.gantt.misc.AxisTime(b,c,this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale;}var r={"viewRangeSet":v,"visibleScale":d,"dstScale":e,"normalScale":n};return r;};A.prototype._calculateTimeRange=function(d,s,e,a){if(d.length){var b=s;var c=e;var f=[];var g=[];var h,i;h=d[0].startDate;i=d[0].endDate;this._calculateRangeItem(h,i,b,c,f,g);if(d.length>1){for(var j=1;j<d.length;j++){if(f.length){var r=[];for(var k in f){r.push(f[k]);}f=[];for(var t=0;t<r.length;t++){h=d[j].startDate;i=d[j].endDate;b=r[t].range[0];c=r[t].range[1];this._calculateRangeItem(h,i,b,c,f,g);}}}}for(var l in g){a.push(g[l]);}for(var m in f){a.push(f[m]);}}};A.prototype._calculateRangeItem=function(d,a,s,e,t,b){var r=null;if(s<d){if(e<a){if(e>d){r={};r.haveDST=false;r.range=[s,d];t.push(r);r={};r.haveDST=true;r.range=[d,e];r.dstRange=[d3.time.second.offset(d.getTime(),60*60),d3.time.second.offset(e,60*60)];b.push(r);}else{r={};r.haveDST=false;r.range=[s,e];t.push(r);}}else{r={};r.haveDST=false;r.range=[s,d];t.push(r);r={};r.haveDST=true;r.range=[d,a];r.dstRange=[d3.time.second.offset(d.getTime(),60*60),d3.time.second.offset(a.getTime(),60*60)];b.push(r);r={};r.haveDST=false;r.range=[a,e];t.push(r);}}else if(s>=d){if(s<a){if(e<=a){r={};r.haveDST=true;r.range=[s,e];r.dstRange=[d3.time.second.offset(s,60*60),d3.time.second.offset(e,60*60)];b.push(r);}else{r={};r.haveDST=true;r.range=[s,a];r.dstRange=[d3.time.second.offset(s,60*60),d3.time.second.offset(a.getTime(),60*60)];b.push(r);r={};r.haveDST=false;r.range=[a,e];t.push(r);}}else{r={};r.haveDST=false;r.range=[s,e];t.push(r);}}};A.prototype.getTimeLabel=function(l,f,d){var F=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:f},new sap.ui.core.Locale(l));return F.format(d);};return A;},true);
