(function(){"use strict";jQuery.sap.require("sap.ovp.cards.ActionUtils");jQuery.sap.require("sap.ui.generic.app.navigation.service.NavigationHandler");jQuery.sap.require("sap.ovp.cards.CommonUtils");var A=sap.ovp.cards.ActionUtils;sap.ui.controller("sap.ovp.cards.generic.Card",{onInit:function(){var h=this.getView().byId("ovpCardHeader");h.attachBrowserEvent("click",this.onHeaderClick.bind(this));h.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&(E.keyCode==13||E.keyCode==32)){E.preventDefault();this.onHeaderClick();}}.bind(this)});var n=this.getView().byId("kpiNumberValue");if(n){n.addEventDelegate({onAfterRendering:function(){var $=n.$();var a=$.find(".sapMNCValueScr");var b=$.find(".sapMNCScale");a.attr("aria-label",a.text());b.attr("aria-label",b.text());}});}try{var c=this.getOwnerComponent().getComponentData();if(c.appComponent&&c.appComponent.getDashboardLayoutUtil){var d=c.appComponent.getDashboardLayoutUtil();if(d&&d.isCardAutoSpan(c.cardId)){this.resizeHandlerId=sap.ui.core.ResizeHandler.register(this.getView(),function(E){jQuery.sap.log.info("DashboardLayout autoSize:"+E.target.id+" -> "+E.size.height);d.setAutoCardSpanHeight(E);});this.oDashboardLayoutUtil=d;this.cardId=c.cardId;}}}catch(e){jQuery.sap.log.error("DashboardLayout autoSpan check failed.");}},exit:function(){if(this.resizeHandlerId){sap.ui.core.ResizeHandler.deregister(this.resizeHandlerId);}},onAfterRendering:function(){var f=this.getCardPropertiesModel().getProperty("/footerFragment");if(f){this._handleCountFooter();}var s=this.getCardPropertiesModel().getProperty("/selectedKey");if(s){this.getView().byId("ovp_card_dropdown").setSelectedKey(s);}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=jQuery("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var i=0;i=this.checkNavigation();if(i){this.getView().addStyleClass("sapOvpCardNavigable");}var d=this.getView().byId("ovp_card_dropdown");var t=this.getView().byId("toolbar");if(t){var a=t.getDomRef();jQuery(a).attr("aria-label",d.getValue());}},onHeaderClick:function(){this.doNavigation(this.getView().getBindingContext());},resizeCard:function(c){jQuery.sap.log.info(c);if(this.resizeHandlerId){sap.ui.core.ResizeHandler.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountFooter:function(){var c=this.getView().byId("ovpCountFooter");if(c){var i=this.getCardItemsBinding();if(i){i.attachDataReceived(function(){var t=i.getLength();var C=i.getCurrentContexts().length;var a=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Count_Zero_Footer");if(t!==0){a=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Count_Footer",[C,t]);}c.setText(a);c.data("aria-label",a);});}}},getCardItemsBinding:function(){},onActionPress:function(e){var s=e.getSource(),c=this._getActionObject(s),a=s.getBindingContext();if(c.type.indexOf("DataFieldForAction")!==-1){this.doAction(a,c);}else{this.doNavigation(a,c);}},_getActionObject:function(s){var c=s.getCustomData();var C={};for(var i=0;i<c.length;i++){C[c[i].getKey()]=c[i].getValue();}return C;},doNavigation:function(c,n){if(!n){n=this.getEntityNavigationEntries(c)[0];}if(n){switch(n.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(c,n);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(c,n);break;}}},doNavigationWithUrl:function(c,n){var p=sap.ushell.Container.getService("URLParsing");if(!(p.isIntentUrl(n.url))){window.open(n.url);}else{var P=p.parseShellHash(n.url);this.doIntentBasedNavigation(c,P);}},doIntentBasedNavigation:function(c,i){var p,n,e=c?c.getObject():null;if(e&&e.__metadata){delete e.__metadata;}var N=sap.ovp.cards.CommonUtils.getNavigationHandler();if(N){if(i){p=this._getEntityNavigationParameters(e);n={target:{semanticObject:i.semanticObject,action:i.action},appSpecificRoute:i.appSpecificRoute,params:p.newSelectionVariant};var a={selectionVariant:p.oldSelectionVariant};var h=function(E){if(E instanceof Error){E.showMessageBox();}};N.navigate(n.target.semanticObject,n.target.action,n.params,a,h);}}},doAction:function(c,a){this.actionData=A.getActionInfo(c,a,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},checkNavigation:function(){if(this.getEntityType()){var e=this.getEntityType();if(this.getCardPropertiesModel()){var c=this.getCardPropertiesModel();var I=c.getProperty("/identificationAnnotationPath");var a=I;var r=e[a];if(r&&r.length){for(var i=0;i<r.length;i++){var o=r[i];if(o.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||o.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||o.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}}}return 0;},getEntityNavigationEntries:function(c,a){var n=[];var e=this.getEntityType();if(!a){var C=this.getCardPropertiesModel();var I=C.getProperty("/identificationAnnotationPath");a=I;}var r=e[a];if(Array.isArray(r)){r=sap.ovp.cards.AnnotationHelper.sortCollectionByImportance(r);for(var i=0;i<r.length;i++){if(r[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push({type:r[i].RecordType,semanticObject:r[i].SemanticObject.String,action:r[i].Action.String,label:r[i].Label?r[i].Label.String:null});}if(r[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!r[i].Url.UrlRef){var m=this.getView().getModel();var M=m.oMetaModel;var E=M.createBindingContext(e.$path);var b=sap.ui.model.odata.AnnotationHelper.format(E,r[i].Url);var o=new sap.ui.core.CustomData({key:"url",value:b});o.setModel(m);o.setBindingContext(c);var u=o.getValue();n.push({type:r[i].RecordType,url:u,value:r[i].Value.String,label:r[i].Label?r[i].Label.String:null});}}}return n;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){return this.getView().getModel("ovpCardProperties");},getEntitySet:function(){if(!this.entitySet){var e=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet(e);}return this.entitySet;},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_getEntityNavigationParameters:function(e){var u={};var E;var c=this.getOwnerComponent().getComponentData();var g=c?c.globalFilter:undefined;var C=sap.ovp.cards.AnnotationHelper.getCardFilters(this.getCardPropertiesModel());if(C&&C[0]&&C[0].path){C[0].path=C[0].path.replace("/",".");}var s,G;if(e){E=this.getEntityType();var k;for(var i=0;E.property&&i<E.property.length;i++){k=E.property[i].name;var a=e[k];if(e.hasOwnProperty(k)){if(window.Array.isArray(e[k])&&e[k].length===1){u[k]=e[k][0];}else if(jQuery.type(a)!=="object"){u[k]=a;}}}}var b=g?g.getFilterDataAsString():"{}";G=new sap.ui.generic.app.navigation.service.SelectionVariant(b);s=this._buildSelectionVariant(g,C);var n=sap.ovp.cards.CommonUtils.getNavigationHandler();var d=null;if(n){d=n.mixAttributesAndSelectionVariant(u,s.toJSONString());}return{oldSelectionVariant:G?G.toJSONString():null,newSelectionVariant:d?d.toJSONString():null};},_buildSelectionVariant:function(g,c){var G=g?g.getFilterDataAsString():"{}";var s=new sap.ui.generic.app.navigation.service.SelectionVariant(G);var f,v,V;for(var i=0;i<c.length;i++){f=c[i];if(f.path&&f.operator&&typeof f.value1!=="undefined"){v=f.value1.toString();V=(typeof f.value2!=="undefined")?f.value2.toString():undefined;s.addSelectOption(f.path,"I",f.operator,v,V);}}return s;},_loadParametersForm:function(){var p=new sap.ui.model.json.JSONModel();p.setData(this.actionData.parameterData);var t=this;var P=new sap.m.Dialog('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){P.destroy();}}).addStyleClass("sapUiNoContentPadding");var a=new sap.m.Button({text:this.actionData.sFunctionLabel,press:function(e){var m=A.getParameters(e.getSource().getModel(),t.actionData.oFunctionImport);P.close();t._callFunction(m);}});var c=new sap.m.Button({text:"Cancel",press:function(){P.close();}});P.setBeginButton(a);P.setEndButton(c);var o=function(e){var m=A.mandatoryParamsMissing(e.getSource().getModel(),t.actionData.oFunctionImport);a.setEnabled(!m);};var f=A.buildParametersForm(this.actionData,o);P.addContent(f);P.setModel(p);P.open();},_callFunction:function(u){var p={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:u,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var P=new Promise(function(r,a){var m=t.actionData.oContext.getModel();var f;f="/"+p.functionImport.name;m.callFunction(f,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,success:function(d,R){r(R);},error:function(R){a(R);}});});P.then(function(r){return sap.m.MessageToast.show(sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Toast_Action_Success"),{duration:1000});},function(e){return sap.m.MessageToast.show(sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Toast_Action_Error"),{duration:1000});});},setErrorState:function(){var c=this.getOwnerComponent();var C=c.oContainer;var o=this.getCardPropertiesModel();var a={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:o.getProperty("/category"),title:o.getProperty("/title"),description:o.getProperty("/description"),entitySet:o.getProperty("/entitySet"),state:sap.ovp.cards.loading.State.ERROR}}};var l=sap.ui.component(a);C.setComponent(l);setTimeout(function(){c.destroy();},0);},changeSelection:function(e){var d=this.getView().byId("ovp_card_dropdown");var s=parseInt(d.getSelectedKey(),10);var t=this.getCardPropertiesModel().getProperty("/tabs")[s-1];var u={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:s};for(var p in t){u[p]=t[p];}this.getOwnerComponent().getComponentData().mainComponent.recreateCard(u);}});})();
